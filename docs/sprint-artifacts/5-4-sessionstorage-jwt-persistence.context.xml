<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>5.4</storyId>
    <title>sessionStorage JWT Persistence</title>
    <status>drafted</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/5-4-sessionstorage-jwt-persistence.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>government user</asA>
    <iWant>my authentication to persist across browser tabs</iWant>
    <soThat>I don't need to sign in again when opening NDX in a new tab</soThat>
    <tasks>
      - Task 1: Validate sessionStorage Persistence Behavior (AC: #1, #2, #3)
        - 1.1: Test sessionStorage persistence in DevTools (Application → Session Storage)
        - 1.2: Verify token accessible when opening new browser tab
        - 1.3: Verify token cleared when browser closes completely
        - 1.4: Document expected vs actual behavior in test results
      - Task 2: Verify AuthState Updates Across Tabs (AC: #1)
        - 2.1: Open NDX in tab 1, sign in, verify "Sign out" visible
        - 2.2: Open NDX in tab 2, verify "Sign out" visible (no re-auth)
        - 2.3: Make API call in tab 2, verify Authorization header present
        - 2.4: Sign out in tab 1, verify tab 2 auth state remains (tabs independent)
      - Task 3: Test Browser Close/Restart Scenario (AC: #2)
        - 3.1: Sign in, close all NDX tabs, close browser completely
        - 3.2: Reopen browser, navigate to NDX
        - 3.3: Verify "Sign in" button visible (not "Sign out")
        - 3.4: Verify sessionStorage empty (no `isb-jwt` token)
        - 3.5: Attempt to access /try page, verify unauthenticated state shown
      - Task 4: Document Testing Results
        - 4.1: Capture screenshots of DevTools session storage panel
        - 4.2: Document cross-tab behavior (expected vs actual)
        - 4.3: Document browser close behavior (expected vs actual)
        - 4.4: Add findings to story completion notes
    </tasks>
  </story>

  <acceptanceCriteria>
    1. **Cross-Tab Persistence**
       - Given I have signed in and JWT token is in sessionStorage
       - When I open NDX in a new browser tab
       - Then I am still authenticated (sessionStorage accessible in new tab)
       - And I see "Sign out" button (not "Sign in")
       - And I can make authenticated API calls without re-authenticating

    2. **Browser Close Behavior**
       - Given I close all NDX tabs and browser
       - When I reopen browser and navigate to NDX
       - Then I am NOT authenticated (sessionStorage cleared)
       - And I see "Sign in" button
       - And I need to sign in again to access Try features

    3. **Validation in DevTools**
       - sessionStorage behavior validates in browser DevTools → Application → Session Storage
       - Token visible in sessionStorage with key `isb-jwt`
       - Token persists when opening new tabs
       - Token clears when browser closes
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document - Try Before You Buy</title>
        <section>FR-TRY-8: sessionStorage JWT Persistence</section>
        <snippet>JWT token must persist across browser tabs for same session (sessionStorage behavior). Users can open multiple NDX tabs without re-authenticating.</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document - Try Before You Buy</title>
        <section>FR-TRY-9: Browser Close Security</section>
        <snippet>JWT token must clear when browser is closed (sessionStorage automatic behavior). Protects government shared devices by requiring re-authentication after browser restart.</snippet>
      </doc>
      <doc>
        <path>docs/try-before-you-buy-architecture.md</path>
        <title>Try Before You Buy - Architecture Document</title>
        <section>ADR-016: sessionStorage for JWT tokens</section>
        <snippet>Use sessionStorage (NOT localStorage, NOT cookies) for JWT token storage. Rationale: Security vs UX trade-off - persists across tabs (good UX), clears on browser close (government shared device security), no server-side session needed (stateless JWT).</snippet>
      </doc>
      <doc>
        <path>docs/try-before-you-buy-architecture.md</path>
        <title>Try Before You Buy - Architecture Document</title>
        <section>ADR-024: Authentication State Management</section>
        <snippet>Reactive authentication state using event-driven pattern. AuthState notifies subscribers when auth status changes (login, logout, token refresh). Components subscribe to auth state: nav links, try buttons, /try page. Note: Current implementation may have tab independence - each tab has own AuthState instance (storage event not implemented in MVP).</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-5-authentication-foundation.md</path>
        <title>Epic 5: Authentication Foundation</title>
        <section>Story 5.4: sessionStorage JWT Persistence</section>
        <snippet>Validation story - confirms native sessionStorage API behavior meets PRD requirements. No new code required unless validation reveals unexpected behavior. Testing focuses on cross-tab persistence and browser close security.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>src/try/auth/auth-provider.ts</path>
        <kind>service</kind>
        <symbol>AuthState</symbol>
        <lines>49-217</lines>
        <reason>Core authentication state manager. Uses sessionStorage with key 'isb-jwt' for JWT token storage. Implements event-driven pattern for auth state changes. Already implemented in Story 5.1-5.3.</reason>
      </artifact>
      <artifact>
        <path>src/try/auth/auth-provider.ts</path>
        <kind>method</kind>
        <symbol>isAuthenticated()</symbol>
        <lines>82-92</lines>
        <reason>Checks if JWT token exists in sessionStorage. Returns true if token present, false otherwise. This is the primary method for determining auth status across tabs.</reason>
      </artifact>
      <artifact>
        <path>src/try/auth/oauth-flow.ts</path>
        <kind>service</kind>
        <symbol>extractTokenFromURL(), handleOAuthCallback()</symbol>
        <lines>230-341</lines>
        <reason>Token extraction and storage logic from Story 5.3. Uses sessionStorage.setItem('isb-jwt', token) which provides automatic cross-tab persistence and browser-close cleanup.</reason>
      </artifact>
      <artifact>
        <path>src/try/auth/auth-provider.test.ts</path>
        <kind>test</kind>
        <symbol>AuthState tests</symbol>
        <lines>1-end</lines>
        <reason>Existing unit tests for AuthState class. May need to add cross-tab sessionStorage behavior tests if not already present.</reason>
      </artifact>
      <artifact>
        <path>src/try/auth/oauth-flow.test.ts</path>
        <kind>test</kind>
        <symbol>OAuth flow tests</symbol>
        <lines>1-end</lines>
        <reason>Existing unit tests for OAuth flow utilities. May need to add sessionStorage persistence tests if not already present.</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <jest>^29.7.0</jest>
        <ts-jest>^29.2.5</ts-jest>
        <jest-environment-jsdom>^29.7.0</jest-environment-jsdom>
        <typescript>^5.7.2</typescript>
        <esbuild>^0.24.2</esbuild>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    - **No New Code Required:** This is a validation story - confirms sessionStorage API behavior meets requirements
    - **Token Key Consistency:** Must use 'isb-jwt' key across all Epic 5+ stories (established in Story 5.3)
    - **Native Web API:** sessionStorage cross-tab persistence and browser-close behavior is provided by Web Storage API standard - no custom implementation needed
    - **DevTools Validation:** Manual testing in browser DevTools (Application → Session Storage) required
    - **Cross-Browser Testing:** Validate behavior in Chrome, Firefox, Safari, Edge (latest 2 versions)
    - **Defensive Programming:** AuthState already handles sessionStorage unavailability (private browsing mode) gracefully
    - **ADR-016 Compliance:** sessionStorage choice (not localStorage, not cookies) for security vs UX balance
    - **Tab Independence:** Current implementation has tab-independent AuthState instances (no storage event listener) - this is acceptable for MVP
  </constraints>

  <interfaces>
    <interface>
      <name>sessionStorage.setItem()</name>
      <kind>Web Storage API</kind>
      <signature>sessionStorage.setItem(key: string, value: string): void</signature>
      <path>Browser Native API</path>
    </interface>
    <interface>
      <name>sessionStorage.getItem()</name>
      <kind>Web Storage API</kind>
      <signature>sessionStorage.getItem(key: string): string | null</signature>
      <path>Browser Native API</path>
    </interface>
    <interface>
      <name>sessionStorage.removeItem()</name>
      <kind>Web Storage API</kind>
      <signature>sessionStorage.removeItem(key: string): void</signature>
      <path>Browser Native API</path>
    </interface>
    <interface>
      <name>AuthState.isAuthenticated()</name>
      <kind>Function signature</kind>
      <signature>isAuthenticated(): boolean</signature>
      <path>src/try/auth/auth-provider.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Project uses Jest with TypeScript (ts-jest) and jest-environment-jsdom for testing client-side code.
      Tests located in same directory as source files with .test.ts suffix.
      Testing philosophy: Unit tests for business logic, manual testing for browser behavior validation.
      This story requires primarily manual testing in browser (not automated unit tests).
    </standards>

    <locations>
      - src/try/auth/auth-provider.test.ts (existing unit tests)
      - src/try/auth/oauth-flow.test.ts (existing unit tests)
      - Manual testing: Browser DevTools → Application → Session Storage panel
    </locations>

    <ideas>
      <test ac="1,2,3" type="manual">
        **Manual Test 1: Cross-Tab Persistence**
        1. Open NDX in Tab 1, sign in via OAuth
        2. Verify "Sign out" button visible
        3. Open DevTools → Application → Session Storage → verify `isb-jwt` token present
        4. Open NDX in new Tab 2
        5. Expected: "Sign out" button visible in Tab 2 (no re-authentication)
        6. Verify same `isb-jwt` token visible in Tab 2 DevTools
      </test>

      <test ac="2,3" type="manual">
        **Manual Test 2: Browser Close Clears Token**
        1. Sign in to NDX
        2. Verify `isb-jwt` token present in DevTools Session Storage
        3. Close all NDX tabs
        4. Close browser completely
        5. Reopen browser, navigate to NDX
        6. Expected: "Sign in" button visible (not "Sign out")
        7. Verify DevTools Session Storage is empty (no `isb-jwt`)
      </test>

      <test ac="1" type="manual">
        **Manual Test 3: API Calls Across Tabs**
        1. Sign in in Tab 1
        2. Open Tab 2, navigate to /try page
        3. Expected: Sessions table loads (authenticated API call succeeds)
        4. Open browser Network tab, verify Authorization header present: "Bearer {token}"
      </test>

      <test ac="2" type="manual">
        **Manual Test 4: Unauthenticated State After Restart**
        1. Close browser after sign in
        2. Reopen browser, navigate to /try page
        3. Expected: Empty state UI "Sign in to view your try sessions"
        4. Verify API calls do NOT include Authorization header (no token)
      </test>

      <test ac="1,2,3" type="unit">
        **Unit Test (if needed): sessionStorage mock behavior**
        - Mock sessionStorage in Jest tests
        - Verify AuthState.isAuthenticated() returns true when token present
        - Verify AuthState.isAuthenticated() returns false when token absent
        - Note: Cannot fully test cross-tab behavior in unit tests - requires manual testing
      </test>
    </ideas>
  </tests>
</story-context>
