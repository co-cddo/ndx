// GOV.UK Frontend components
$_font-family: Arial, sans-serif;
@use "pkg:govuk-frontend/dist/govuk" with (
  $govuk-font-family: $_font-family
);

// GOV.UK Eleventy Plugin components
@use "pkg:@x-govuk/govuk-eleventy-plugin";

.x-govuk-masthead__image img[src$=".svg"] {
  width: 100%;
  margin: -20% -20% -20% 0;
}

// Make navigation emoji black and white
.govuk-service-navigation__item a {
  .emoji {
    filter: grayscale(100%) invert(100%);
  }
  .sparkle {
    animation: sparkle 15s ease-in-out infinite;
    display: inline-block;
  }
}

@keyframes sparkle {
  0% {
    filter: hue-rotate(0deg) brightness(1);
  }
  25% {
    filter: hue-rotate(90deg) brightness(1.2);
  }
  50% {
    filter: hue-rotate(180deg) brightness(1.5);
  }
  75% {
    filter: hue-rotate(270deg) brightness(1.2);
  }
  100% {
    filter: hue-rotate(360deg) brightness(1);
  }
}

.homepage-grid {
  $icons: (discover, access, learn, try, optimise);

  h3 {
    a {
      background: {
        size: 3vw;
        repeat: no-repeat;
        position: -0.5vw center;
      }
      padding-left: 2vw;
    }

    @each $icon in $icons {
      &##{$icon} a {
        background-image: url(icons/#{$icon}.svg);
      }
    }
  }
}

// Review star styling
.govuk-summary-list .govuk-summary-list__value {
  span[aria-hidden="true"] {
    color: #b1b4b6;
    font-size: 1.25rem;

    &.lit {
      color: #ffdd00 !important;
    }
  }
}

.govuk-footer__crown {
  display: none;
}

// AUP Modal styles - Story 6.6
// Moved from JavaScript to comply with CSP (no inline styles)
.aup-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
  overflow-y: auto;

  &[aria-hidden="true"] {
    display: none;
  }
}

.aup-modal {
  background: #fff;
  max-width: 640px;
  width: 100%;
  border-radius: 0;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  margin: auto;

  &__header {
    padding: 20px 30px;
    border-bottom: 1px solid #b1b4b6;
  }

  &__title {
    margin: 0;
  }

  &__body {
    padding: 20px 30px;
  }

  &__info {
    margin-bottom: 20px;
    padding: 15px;
    background: #f3f2f1;
    border-left: 4px solid #1d70b8;
  }

  &__info-text {
    margin: 0;

    & + & {
      margin-top: 10px;
    }
  }

  &__aup-container {
    padding: 15px;
    border: 2px solid #b1b4b6;
    background: #fff;
    margin-bottom: 20px;
    max-height: 300px;
    overflow-y: auto;
  }

  &__aup-content {
    margin: 0;
    white-space: pre-wrap;
  }

  &__checkbox-group {
    margin-bottom: 20px;
  }

  &__footer {
    padding: 20px 30px;
    border-top: 1px solid #b1b4b6;
    display: flex;
    gap: 15px;
    justify-content: flex-start;
  }

  &__error {
    padding: 15px;
    margin-bottom: 20px;
    background: #f3f2f1;
    border-left: 4px solid #d4351c;
    // Use GOV.UK text colour for WCAG AA contrast (4.5:1+)
    // Red border provides visual error indication
    color: #0b0c0c;

    // Hidden by default, shown via class
    &--hidden {
      display: none;
    }
  }

  &__loading {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 20px;
    color: #505a5f;
  }

  &__spinner {
    width: 24px;
    height: 24px;
    border: 3px solid #b1b4b6;
    border-top-color: #1d70b8;
    border-radius: 50%;
    animation: aup-spin 1s linear infinite;
  }

  // Story 9.2: Session terms container
  &__session-terms {
    min-height: 48px; // Prevent layout shift during loading
  }

  // Story 9.2: Loading skeleton for session terms
  &__skeleton {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  &__skeleton-line {
    height: 20px;
    width: 60%;
    background: linear-gradient(90deg, #e0e0e0 0%, #f0f0f0 50%, #e0e0e0 100%);
    background-size: 200% 100%;
    animation: aup-skeleton-pulse 1.5s ease-in-out infinite;
    border-radius: 4px;

    &:last-child {
      width: 50%;
    }
  }

  // Story 9.2: Error styling for unknown values
  &__value--error {
    color: #d4351c;
    font-weight: 700;
  }
}

@keyframes aup-spin {
  to {
    transform: rotate(360deg);
  }
}

// Story 9.2: Skeleton pulse animation
@keyframes aup-skeleton-pulse {
  0% {
    background-position: 200% 0;
  }
  100% {
    background-position: -200% 0;
  }
}

// Body scroll lock when modal is open
body.aup-modal-open {
  overflow: hidden;
}

// ============================================================================
// Auth Choice Modal - Story 2.1
// ============================================================================
// Modal for choosing between sign in and create account
// Follows same pattern as AUP modal for consistency
// ============================================================================

.auth-choice-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
  overflow-y: auto;

  &[aria-hidden="true"] {
    display: none;
  }
}

.auth-choice-modal {
  background: #fff;
  max-width: 500px;
  width: 90%;
  border-radius: 0;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  margin: auto;

  &__header {
    padding: 20px 20px 0;
  }

  &__title {
    margin: 0;
  }

  &__body {
    padding: 20px;
  }

  &__footer {
    padding: 0 20px 20px;
    display: flex;
    gap: 15px;

    .govuk-button {
      margin-bottom: 0;
    }
  }
}

// Body scroll lock when auth choice modal is open
body.auth-choice-modal-open {
  overflow: hidden;
}

// Document list title with inline tag - Story 6.2
.app-document-list__item-title {
  display: flex;
  flex-wrap: wrap;
  align-items: baseline;
  gap: 0.5em;

  .govuk-tag {
    flex-shrink: 0;
  }
}

// ============================================================================
// Mermaid Diagram Styles - Build-Time SVG Rendering
// ============================================================================
// These styles replace the inline <style> tag from Mermaid to comply with CSP.
// The Mermaid plugin strips all inline styles, and these external styles provide
// the visual appearance using the SVG's class structure.
//
// CSS Custom Properties enable easy theming without modifying the stylesheet.
// Override these variables in a parent element to customize diagram appearance.
// ============================================================================

.mermaid-diagram {
  // Theme variables for easy customization
  // Override these to create custom themes
  --mermaid-node-fill: #ececff;
  --mermaid-node-stroke: #9370db;
  --mermaid-node-stroke-width: 1px;
  --mermaid-edge-stroke: #333;
  --mermaid-edge-stroke-width: 2px;
  --mermaid-label-color: #333;
  --mermaid-cluster-fill: #ffffde;
  --mermaid-cluster-stroke: #aaaa33;
  --mermaid-edge-label-bg: rgba(232, 232, 232, 0.8);
  --mermaid-font-family: Arial, sans-serif;
  --mermaid-font-size: 16px;

  margin: 2em 0;
  position: relative;

  // Scope all SVG styles to direct child to prevent style leakage
  // to other SVGs that might be on the page
  > svg {
    max-width: 100%;
    height: auto;
    display: block;

    // ========================================
    // Node styling (rectangles in flowcharts)
    // ========================================
    .node rect,
    .node circle,
    .node ellipse,
    .node polygon,
    .node path {
      fill: var(--mermaid-node-fill);
      stroke: var(--mermaid-node-stroke);
      stroke-width: var(--mermaid-node-stroke-width);
    }

    // Node labels
    .node .label,
    .nodeLabel {
      color: var(--mermaid-label-color);
      fill: var(--mermaid-label-color);
    }

    // ========================================
    // Edge styling (arrows/lines between nodes)
    // ========================================
    .edgePath path {
      stroke: var(--mermaid-edge-stroke);
      stroke-width: var(--mermaid-edge-stroke-width);
    }

    .edgePath .path {
      stroke: var(--mermaid-edge-stroke);
      fill: none;
    }

    // Arrow markers
    .marker,
    .arrowMarkerPath {
      fill: var(--mermaid-edge-stroke);
      stroke: var(--mermaid-edge-stroke);
    }

    // Edge labels
    .edgeLabel {
      background-color: var(--mermaid-edge-label-bg);
      text-align: center;
    }

    .edgeLabel rect {
      opacity: 0.5;
      fill: var(--mermaid-node-fill);
      stroke: var(--mermaid-node-stroke);
    }

    // ========================================
    // Cluster styling (subgraphs)
    // ========================================
    .cluster rect {
      fill: var(--mermaid-cluster-fill);
      stroke: var(--mermaid-cluster-stroke);
      stroke-width: var(--mermaid-node-stroke-width);
    }

    .cluster text {
      fill: var(--mermaid-label-color);
    }

    // ========================================
    // Labels and containers
    // ========================================
    .label-container {
      fill: var(--mermaid-node-fill);
      stroke: var(--mermaid-node-stroke);
    }

    // Flowchart specific links
    .flowchart-link {
      stroke: var(--mermaid-edge-stroke);
      fill: none;
    }

    // ========================================
    // Text styling - match GOV.UK font stack
    // ========================================
    text {
      font-family: var(--mermaid-font-family);
      font-size: var(--mermaid-font-size);
    }

    // Foreign object text (HTML inside SVG)
    foreignObject {
      text-align: center;
      font-family: var(--mermaid-font-family);

      div {
        display: table-cell;
        white-space: normal;
        line-height: 1.5;
        max-width: 200px;
        text-align: center;
      }

      p {
        margin: 0;
        padding: 2px;
        background-color: transparent;
        color: var(--mermaid-label-color);
        font-family: var(--mermaid-font-family);
        font-size: var(--mermaid-font-size);
      }
    }

    // Basic shapes fallback
    .basic {
      fill: var(--mermaid-node-fill);
      stroke: var(--mermaid-node-stroke);
    }
  }

  // ========================================
  // Theme variants via data attribute
  // ========================================
  // Usage: <figure class="mermaid-diagram" data-mermaid-theme="dark">
  &[data-mermaid-theme="dark"] {
    --mermaid-node-fill: #1f2020;
    --mermaid-node-stroke: #81b1db;
    --mermaid-edge-stroke: #81b1db;
    --mermaid-label-color: #ccc;
    --mermaid-cluster-fill: #333;
    --mermaid-cluster-stroke: #666;
    --mermaid-edge-label-bg: rgba(0, 0, 0, 0.8);
  }

  &[data-mermaid-theme="forest"] {
    --mermaid-node-fill: #cde498;
    --mermaid-node-stroke: #13540c;
    --mermaid-edge-stroke: #13540c;
    --mermaid-label-color: #333;
    --mermaid-cluster-fill: #e8f5e9;
    --mermaid-cluster-stroke: #2e7d32;
  }

  &[data-mermaid-theme="neutral"] {
    --mermaid-node-fill: #f4f4f4;
    --mermaid-node-stroke: #666;
    --mermaid-edge-stroke: #333;
    --mermaid-label-color: #333;
    --mermaid-cluster-fill: #fafafa;
    --mermaid-cluster-stroke: #999;
  }
}

// Hidden source code container (for accessibility/SEO)
.mermaid-source-details {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

// Error state styling for failed diagram renders
.mermaid-error {
  padding: 1em;
  background: #f3f2f1;
  border-left: 4px solid #d4351c;
  margin: 2em 0;

  p {
    color: #d4351c;
    margin: 0 0 1em;

    strong {
      font-weight: bold;
    }
  }

  details {
    margin-bottom: 1em;

    summary {
      cursor: pointer;
      color: #1d70b8;
      text-decoration: underline;

      &:hover {
        color: #003078;
      }
    }

    p {
      color: #505a5f;
      font-family: monospace;
      font-size: 0.875rem;
      margin: 0.5em 0 0;
      padding: 0.5em;
      background: #fff;
    }
  }

  pre {
    background: #fff;
    padding: 1em;
    overflow-x: auto;
    font-size: 0.875rem;
    margin: 0;
  }
}

// ============================================================================
// Signup Form - Split Email Input (Story 1.5)
// ============================================================================
// Split email input: local part text input + "@" + domain dropdown
// Follows GOV.UK Design System patterns for form components
// ============================================================================

.ndx-email-input {
  display: flex;
  flex-wrap: wrap;
  align-items: flex-start;
  gap: 5px;

  &__local {
    flex: 1;
    min-width: 150px;
    max-width: 200px;
  }

  &__at {
    padding: 10px 5px 0;
    font-size: 19px;
    line-height: 1.3;
    color: #0b0c0c; // GOV.UK text colour
  }

  &__domain {
    flex: 2;
    min-width: 200px;
  }
}

// Mobile: Stack vertically
@media (max-width: 640px) {
  .ndx-email-input {
    flex-direction: column;
    gap: 10px;

    &__local,
    &__domain {
      width: 100%;
      max-width: none;
    }

    &__at {
      display: none; // Hide @ on mobile, user understands format
    }
  }
}

// ============================================================================
// Auth Nav Button - Link Appearance
// ============================================================================
// Makes the Sign in button look like a link to match other nav items
// Button is used instead of anchor for semantic correctness (triggers JS action)
// ============================================================================

// Sign in button in header navigation - styled to match other nav links
// Matches .govuk-service-navigation__link styling for buttons
#sign-in-button {
  // Reset button defaults
  background: none;
  border: none;
  padding: 0;
  margin: 0;
  cursor: pointer;

  // Match GDS typography (govuk-font size 19)
  font-family: Arial, sans-serif;
  font-size: 1.1875rem; // 19px
  line-height: 1.3157894737; // 25/19
  font-weight: 400;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;

  // Match link styling (no underline by default)
  text-decoration: none;
  // Default: darkened link color for non-inverse nav (matches govuk-service-navigation-link-colour)
  color: #1559a3;

  &:hover {
    text-decoration: underline;
    text-decoration-thickness: max(3px, 0.1875rem, 0.12em);
    text-underline-offset: 0.1578em;
  }

  &:focus {
    outline: 3px solid transparent;
    color: #0b0c0c;
    background-color: #fd0;
    box-shadow:
      0 -2px #fd0,
      0 4px #0b0c0c;
    text-decoration: none;
  }
}

// Inverse navigation context (blue background) - use white
.govuk-service-navigation--inverse #sign-in-button {
  color: #fff;

  &:hover {
    color: #fff;
  }
}

// govuk-body
.experimental_header {
  @extend .govuk-body;
  background: yellow;
  padding: 5px;
  margin-bottom: 0;

  p {
    @extend .govuk-width-container;
    text-align: center;
    font-weight: bold;
  }
}
