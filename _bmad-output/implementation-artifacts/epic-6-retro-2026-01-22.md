# Epic 6 Retrospective: Operations Notifications

**Date:** 2026-01-22
**Epic:** Operations Notifications
**Status:** Complete
**Stories Completed:** 3/3

## Epic Summary

Epic 6 (Operations Notifications) modernized the notification infrastructure by:
1. Integrating AWS Chatbot for EventBridge → SNS → Slack delivery (Story 6-1)
2. Adding @channel mentions for 4 critical events (Story 6-2)
3. Removing legacy Slack webhook code (~2200 lines) (Story 6-3)

**FRs Delivered:** FR7, FR8, FR9, FR10, FR15

---

## Team Discussion

### SM (Scrum Master)

Welcome team! Epic 6 is complete with all 3 stories delivered. This was a significant infrastructure modernization - we migrated from direct Slack webhooks to AWS Chatbot and cleaned up over 2000 lines of legacy code.

**Metrics Overview:**
- Stories: 3 completed (6-1, 6-2, 6-3)
- Code deleted: ~2200 lines (7 source files)
- Tests: 803 notification tests passing
- Code review issues: 3 found and fixed in Story 6-3

---

### Dev Agent

**What Went Well:**

1. **Clean Infrastructure Addition (Story 6-1):** The AWS Chatbot integration was straightforward following CDK patterns. The SNS topic → Chatbot → Slack path is simpler than the Lambda webhook approach.

2. **Parallel Notification Paths (Story 6-2):** Implementing @channel mentions while both paths (webhook + Chatbot) were active allowed validation before removing the old code.

3. **Comprehensive Code Removal (Story 6-3):** Removing 7 files and 2200+ lines of Slack webhook code was clean. The code review caught 3 issues:
   - Stale test assertion for webhook secret path
   - Obsolete SlackFailureAlarm (metric never emitted)
   - Test for removed alarm

**What Could Be Improved:**

1. **Test Cleanup Lag:** Some test assertions referenced removed infrastructure (Slack webhook secret, SlackFailureAlarm). These weren't caught until the code review phase.

2. **Compiled File Caching:** Stale compiled `.js` files caused test failures initially. Had to manually clear compiled files to get fresh TypeScript compilation.

**Technical Debt Addressed:**
- Removed all Slack webhook code (FR15 satisfied)
- Single notification path via AWS Chatbot
- SlackFailureAlarm removed (was monitoring metric that no longer exists)

---

### Architect

**Architecture Observations:**

1. **Simplified Notification Path:** Before Epic 6:
   - Lambda → Slack Webhook (enriched alerts)
   - EventBridge → SNS → Chatbot (raw events)

   After Epic 6:
   - EventBridge → SNS → Chatbot (all events)
   - Lambda → GOV.UK Notify (email only)

2. **Critical Event Classification:** The `includeMention` flag in templates was already designed but not wired. Story 6-2 connected it properly.

3. **Observability Change:** DLQ digest handler now logs to CloudWatch instead of posting to Slack. CloudWatch alarms provide monitoring visibility.

**Concerns:**
- None - architecture is cleaner with single Slack notification path

---

### SM

**Story Analysis:**

#### Story 6-1: AWS Chatbot Integration
- **Complexity:** Medium
- **Tasks:** 6 tasks, all completed
- **Key Achievement:** All 18 ISB event types now route to Slack via Chatbot
- **Tests Added:** 13 new tests

#### Story 6-2: Critical Event Classification
- **Complexity:** Small
- **Tasks:** 7 tasks, all completed
- **Key Achievement:** 4 critical events now trigger @channel alerts
- **Tests Added:** 15 new tests

#### Story 6-3: Remove Slack Webhook Code
- **Complexity:** Medium (large deletion scope)
- **Tasks:** 11 tasks, all completed
- **Files Deleted:** 7 source files, 1 test script
- **Code Removed:** ~2200 lines
- **Code Review Issues:** 3 (all fixed)

---

### TEA (Test Expert)

**Test Coverage Analysis:**

1. **Story 6-1 Tests:**
   - 13 tests covering EventBridge rule, SNS topic, Chatbot configuration
   - Tests verify all 18 event types captured
   - Coverage: All ACs satisfied

2. **Story 6-2 Tests:**
   - 7 tests for @channel mention in payloads
   - 8 tests for GroupCostReportGeneratedFailure formatting
   - Coverage: All ACs satisfied

3. **Story 6-3 Cleanup:**
   - Deleted ~800 lines of test code with webhook files
   - Updated 6 test files to remove webhook references
   - Removed SlackFailureAlarm test
   - Updated alarm count from 12 to 11

**Test Quality:**
- 803 notification tests passing (down from 811 pre-cleanup, expected due to removed tests)
- No flaky tests
- Code review caught stale test assertions

**Recommendations:**
- Consider running full test suite with `--clearCache` after major deletions
- Review infrastructure tests after removing CloudFormation resources

---

### PM (Product Manager)

**Requirements Delivery:**

| FR   | Status | Notes |
|------|--------|-------|
| FR7  | Done   | All ISB events delivered to Slack via Chatbot |
| FR8  | Done   | @channel alerts for 4 critical events |
| FR9  | Done   | Routine events without @channel disruption |
| FR10 | Done   | 18 events route to AWS Chatbot |
| FR15 | Done   | No Slack webhook code in codebase |

**User Value Delivered:**
- Operations team has single, reliable Slack notification path
- Critical events get immediate attention via @channel
- Codebase is cleaner without dual notification paths

**Outstanding Items:**
- None - all Epic 6 requirements satisfied
- AWS Chatbot requires one-time workspace authorization (manual)

---

## Previous Retro Follow-Through (Epic 5)

| Action Item | Status |
|-------------|--------|
| Continue with Epic 6 (Operations Notifications) | Done |
| Apply ISB API pattern learnings to future API integrations | Applied - not needed in Epic 6 |
| Monitor CloudFormation button usage via analytics | Ongoing (PM) |

**Continuity Notes:**
- Epic 5's pattern-based development approach applied well to Epic 6
- Test infrastructure continued to work reliably

---

## Lessons Learned

### What to Keep Doing

1. **Code Review Process:** The adversarial code review caught 3 issues that would have caused test failures in CI. The multi-pass approach works.

2. **Parallel Path Migration:** Having both notification paths active during Story 6-2 allowed validation before removing old code in 6-3. Good incremental approach.

3. **Comprehensive Cleanup:** Story 6-3 didn't just delete code - it updated all references, tests, and infrastructure. No orphaned code.

### What to Improve

1. **Infrastructure Test Alignment:** Tests for CloudWatch alarms should be reviewed when alarm count changes. The SlackFailureAlarm removal wasn't caught until code review.

2. **Compiled File Management:** Stale `.js` files from previous compilations can mask test failures. Consider clearing build artifacts during major refactors.

### What to Start

1. **Pre-Deletion Checklist:** Before deleting infrastructure (alarms, secrets, etc.), verify:
   - No tests reference the resource
   - Resource count assertions are updated
   - No IAM policies grant access to deleted resources

---

## Action Items

| Action | Owner | Status |
|--------|-------|--------|
| Continue with Epic 7 (Product Discovery & Branding) | Dev | Next |
| Complete one-time AWS Chatbot workspace authorization | Ops | Pre-deploy |
| Verify Chatbot notifications in staging | Ops | Post-deploy |

---

## Next Epic Preview

**Epic 7: Product Discovery & Branding** (2 stories)

| Story | Description |
|-------|-------------|
| 7-1   | Catalogue Links - Template names link to catalogue pages |
| 7-2   | Branding Update - "NDX:Try sessions" terminology |

**Dependencies on Epic 6:**
- None - Epic 7 is frontend-focused, Epic 6 was backend infrastructure

**Preparation Needed:**
- Verify catalogue slugs for all 8 templates before Story 7-1
- Audit "Innovation Sandbox" text occurrences before Story 7-2

---

## Metrics Summary

| Metric | Value |
|--------|-------|
| Epic Duration | 1 day |
| Stories Completed | 3 |
| Code Deleted | ~2200 lines |
| Files Deleted | 7 source, 1 script |
| Tests Passing | 803 |
| Code Review Issues | 3 (all fixed) |
| Technical Debt | Reduced (legacy webhook code removed) |

---

## Sign-off

- **SM:** Epic 6 complete, retrospective done
- **Dev:** Ready for Epic 7
- **Architect:** Architecture simplified
- **TEA:** Test coverage maintained
- **PM:** All requirements delivered
