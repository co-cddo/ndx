<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>9</epicId>
    <storyId>9.1</storyId>
    <title>Create Lease Template Service</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/9-1-create-lease-template-service.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>fetch lease template details from the Innovation Sandbox API</iWant>
    <soThat>the AUP modal can display actual duration and budget limits instead of hardcoded values</soThat>
    <tasks>
      <task n="1" title="Create lease-templates-service.ts file" ac="1-3">
        <subtask n="1.1">Create file at src/try/api/lease-templates-service.ts</subtask>
        <subtask n="1.2">Define LeaseTemplateResult interface</subtask>
        <subtask n="1.3">Define LeaseTemplateAPIResponse interface (matches ISB OpenAPI)</subtask>
        <subtask n="1.4">Implement fetchLeaseTemplate(tryId: string) function</subtask>
        <subtask n="1.5">Use callISBAPI() from api-client.ts for authenticated requests</subtask>
        <subtask n="1.6">Wrap in deduplicatedRequest() from request-dedup.ts</subtask>
      </task>
      <task n="2" title="Implement error handling" ac="4-7">
        <subtask n="2.1">Handle 404 - return { success: false, errorCode: 'NOT_FOUND' }</subtask>
        <subtask n="2.2">Handle 401 - rely on callISBAPI() redirect behavior</subtask>
        <subtask n="2.3">Handle 500+ - return { success: false, errorCode: 'SERVER_ERROR' }</subtask>
        <subtask n="2.4">Handle AbortError (timeout) - return { success: false, errorCode: 'TIMEOUT' }</subtask>
        <subtask n="2.5">Handle network errors - return { success: false, errorCode: 'NETWORK_ERROR' }</subtask>
        <subtask n="2.6">Set timeout to 5000ms using config.requestTimeout</subtask>
      </task>
      <task n="3" title="Implement input validation" ac="8">
        <subtask n="3.1">Validate UUID format before API call (regex: /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)</subtask>
        <subtask n="3.2">Return immediate error for invalid UUID (fail fast)</subtask>
      </task>
      <task n="4" title="Implement defensive parsing" ac="10">
        <subtask n="4.1">Parse JSend response format { status, data }</subtask>
        <subtask n="4.2">Extract leaseDurationInHours with default fallback (24)</subtask>
        <subtask n="4.3">Extract maxSpend with default fallback (50)</subtask>
        <subtask n="4.4">Log warning if expected fields missing</subtask>
        <subtask n="4.5">Extract optional name field if present</subtask>
      </task>
      <task n="5" title="Write unit tests" ac="1-10">
        <subtask n="5.1">Create src/try/api/lease-templates-service.test.ts</subtask>
        <subtask n="5.2">Test successful fetch with all fields</subtask>
        <subtask n="5.3">Test successful fetch with missing optional fields</subtask>
        <subtask n="5.4">Test 404 returns NOT_FOUND</subtask>
        <subtask n="5.5">Test 401 triggers redirect</subtask>
        <subtask n="5.6">Test 500 returns SERVER_ERROR</subtask>
        <subtask n="5.7">Test timeout returns TIMEOUT</subtask>
        <subtask n="5.8">Test invalid UUID rejected</subtask>
        <subtask n="5.9">Test concurrent calls deduplicated</subtask>
        <subtask n="5.10">Test malformed response logged</subtask>
      </task>
      <task n="6" title="Export from module" ac="1">
        <subtask n="6.1">Add export to src/try/api/index.ts (if exists) or ensure direct import works</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1" testApproach="Unit: mock fetch">fetchLeaseTemplate(tryId) calls GET /api/leaseTemplates/{tryId} endpoint</criterion>
    <criterion id="AC-2" testApproach="Unit: parse test">Response parsed for leaseDurationInHours and maxSpend fields</criterion>
    <criterion id="AC-3" testApproach="Unit: type validation">Returns typed LeaseTemplateResult with success/data or error/errorCode</criterion>
    <criterion id="AC-4" testApproach="Unit: 404 handling">404 response returns errorCode: 'NOT_FOUND' with user-friendly message</criterion>
    <criterion id="AC-5" testApproach="Unit: auth redirect">401 response triggers auth redirect via callISBAPI()</criterion>
    <criterion id="AC-6" testApproach="Unit: server error">500+ response returns errorCode: 'SERVER_ERROR' with retry guidance</criterion>
    <criterion id="AC-7" testApproach="Unit: timeout handling">Network timeout (>5s) returns errorCode: 'TIMEOUT'</criterion>
    <criterion id="AC-8" testApproach="Unit: validation">Invalid UUID rejected before API call (fail fast)</criterion>
    <criterion id="AC-9" testApproach="Unit: dedup test">Concurrent calls deduplicated via deduplicatedRequest()</criterion>
    <criterion id="AC-10" testApproach="Unit: logging test">Malformed API response (missing required fields) logged as warning</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-9.md</path>
        <title>Epic 9 Technical Specification</title>
        <section>Data Models and Contracts, APIs and Interfaces</section>
        <snippet>Defines LeaseTemplateResult interface and fetchLeaseTemplate() function signature. API endpoint: GET /api/leaseTemplates/{tryId}, timeout 5000ms, JSend format response.</snippet>
      </doc>
      <doc>
        <path>docs/try-before-you-buy-architecture.md</path>
        <title>Try Before You Buy Architecture</title>
        <section>ADR-021, ADR-028</section>
        <snippet>ADR-021: Centralized API Client - use callISBAPI() wrapper. ADR-028: Request Deduplication - wrap in deduplicatedRequest().</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-9-aup-modal-dynamic-lease-details.md</path>
        <title>Epic 9: AUP Modal Dynamic Lease Details</title>
        <section>Story 9.1 Acceptance Criteria</section>
        <snippet>Defines story requirements for lease template service with error handling, timeout, deduplication, and defensive parsing.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/try/api/configurations-service.ts</path>
        <kind>service</kind>
        <symbol>fetchConfigurations</symbol>
        <lines>165-258</lines>
        <reason>Pattern reference: same JSend parsing, deduplicatedRequest, callISBAPI usage, timeout handling</reason>
      </artifact>
      <artifact>
        <path>src/try/api/api-client.ts</path>
        <kind>client</kind>
        <symbol>callISBAPI</symbol>
        <lines>106-143</lines>
        <reason>Must use for authenticated API calls with automatic 401 handling</reason>
      </artifact>
      <artifact>
        <path>src/try/utils/request-dedup.ts</path>
        <kind>utility</kind>
        <symbol>deduplicatedRequest</symbol>
        <lines>50-68</lines>
        <reason>Must wrap fetch in deduplicatedRequest to prevent concurrent duplicate calls (ADR-028)</reason>
      </artifact>
      <artifact>
        <path>src/try/utils/error-utils.ts</path>
        <kind>utility</kind>
        <symbol>getHttpErrorMessage</symbol>
        <lines>75-90</lines>
        <reason>Use for user-friendly error messages from HTTP status codes</reason>
      </artifact>
      <artifact>
        <path>src/try/config.ts</path>
        <kind>config</kind>
        <symbol>config.requestTimeout</symbol>
        <lines>96-102</lines>
        <reason>Use config.requestTimeout (10000ms) for API timeout value</reason>
      </artifact>
      <artifact>
        <path>src/try/api/configurations-service.test.ts</path>
        <kind>test</kind>
        <symbol>describe('Configurations Service')</symbol>
        <lines>1-591</lines>
        <reason>Test pattern reference: mock callISBAPI, test success/error scenarios, test caching, test deduplication</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="typescript" version="^5.7.2" />
        <package name="jest" version="^29.7.0" />
        <package name="jest-environment-jsdom" version="^29.7.0" />
        <package name="ts-jest" version="^29.2.5" />
        <package name="esbuild" version="^0.24.2" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture" source="ADR-021">MUST use callISBAPI() wrapper for all ISB API calls</constraint>
    <constraint type="architecture" source="ADR-028">MUST wrap in deduplicatedRequest() to prevent duplicate concurrent calls</constraint>
    <constraint type="architecture" source="ADR-022">MUST define TypeScript interfaces matching ISB OpenAPI spec</constraint>
    <constraint type="security">Input validation: UUID format validated before API call (fail fast)</constraint>
    <constraint type="security">No caching: lease templates may change, modal is short-lived</constraint>
    <constraint type="reliability">Timeout: 5000ms using AbortController (from config.requestTimeout or 5s fixed)</constraint>
    <constraint type="reliability">Defensive parsing: missing fields use defaults (24h, $50), log warning</constraint>
    <constraint type="observability">Log all API errors with template ID and error code</constraint>
    <constraint type="testing">Jest test file naming: *.test.ts in same directory as source</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>fetchLeaseTemplate</name>
      <kind>function</kind>
      <signature>export async function fetchLeaseTemplate(tryId: string): Promise&lt;LeaseTemplateResult&gt;</signature>
      <path>src/try/api/lease-templates-service.ts</path>
    </interface>
    <interface>
      <name>LeaseTemplateResult</name>
      <kind>interface</kind>
      <signature>export interface LeaseTemplateResult { success: boolean; data?: { leaseDurationInHours: number; maxSpend: number; name?: string }; error?: string; errorCode?: 'NOT_FOUND' | 'UNAUTHORIZED' | 'TIMEOUT' | 'SERVER_ERROR' | 'NETWORK_ERROR' }</signature>
      <path>src/try/api/lease-templates-service.ts</path>
    </interface>
    <interface>
      <name>GET /api/leaseTemplates/{id}</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/leaseTemplates/{leaseTemplateId} -> JSend { status: "success", data: LeaseTemplate }</signature>
      <path>Innovation Sandbox API (external)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Jest with jsdom environment for browser API testing. Mock callISBAPI using jest.mock(). Test all 10 acceptance criteria covering success paths, error handling, timeout, validation, and deduplication. Use async/await patterns. Follow test structure from configurations-service.test.ts with describe blocks for success scenarios, API errors, and network errors.</standards>
    <locations>
      <pattern>src/try/api/*.test.ts</pattern>
    </locations>
    <ideas>
      <idea ac="AC-1">Test that fetchLeaseTemplate calls callISBAPI with correct endpoint /api/leaseTemplates/{tryId}</idea>
      <idea ac="AC-2">Test response parsing extracts leaseDurationInHours and maxSpend from nested JSend data</idea>
      <idea ac="AC-3">Test return type matches LeaseTemplateResult interface with success/data or error/errorCode</idea>
      <idea ac="AC-4">Test 404 response returns { success: false, errorCode: 'NOT_FOUND', error: 'Template not found' }</idea>
      <idea ac="AC-5">Test 401 response triggers redirect (callISBAPI handles this) or returns UNAUTHORIZED if skipAuthRedirect</idea>
      <idea ac="AC-6">Test 500/502/503/504 responses return { success: false, errorCode: 'SERVER_ERROR' }</idea>
      <idea ac="AC-7">Test AbortError from timeout returns { success: false, errorCode: 'TIMEOUT' }</idea>
      <idea ac="AC-8">Test invalid UUID (e.g., 'not-a-uuid', 'abc', '') returns immediate error without API call</idea>
      <idea ac="AC-9">Test concurrent calls to same tryId only make single API request via deduplicatedRequest</idea>
      <idea ac="AC-10">Test missing leaseDurationInHours/maxSpend logs warning and uses defaults (24, 50)</idea>
    </ideas>
  </tests>
</story-context>
