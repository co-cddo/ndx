name: Infrastructure

on:
  workflow_dispatch: # Manual trigger
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  merge_group:
    branches:
      - main

permissions: read-all

env:
  AWS_REGION: us-west-2
  NODE_VERSION: "20.17.0"

jobs:
  # Infrastructure unit tests (always runs to produce a check, but skips tests if no infra changes)
  infra-unit-tests:
    name: Infrastructure Unit Tests
    runs-on: ubuntu-latest
    outputs:
      infra-changed: ${{ steps.changes.outputs.infra }}
    defaults:
      run:
        working-directory: infra

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Check for infra changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: changes
        with:
          filters: |
            infra:
              - 'infra/**'
              - '.github/workflows/infra.yaml'

      - name: Skip notification
        if: steps.changes.outputs.infra != 'true'
        run: |
          echo "::notice::No infrastructure files changed. Tests skipped but check passed."
          echo "Infra tests are only run when files in infra/** or .github/workflows/infra.yaml are modified."

      - name: Enable Corepack
        if: steps.changes.outputs.infra == 'true'
        run: corepack enable

      - name: Setup Node.js
        if: steps.changes.outputs.infra == 'true'
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"
          cache-dependency-path: infra/yarn.lock

      - name: Install dependencies
        if: steps.changes.outputs.infra == 'true'
        run: yarn install --immutable

      - name: Run infrastructure unit tests
        if: steps.changes.outputs.infra == 'true'
        run: yarn test

      - name: Run lint
        if: steps.changes.outputs.infra == 'true'
        run: yarn lint

  # Infrastructure E2E tests (depends on unit tests)
  infra-e2e-tests:
    name: Infrastructure E2E Tests
    if: false # Temporarily disabled - AWS SDK compatibility issue with Jest teardown
    runs-on: ubuntu-latest
    needs: [infra-unit-tests]
    defaults:
      run:
        working-directory: infra

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"
          cache-dependency-path: infra/yarn.lock

      - name: Install dependencies
        run: yarn install --immutable

      - name: Run GOV.UK Notify E2E tests
        env:
          NOTIFY_SANDBOX_API_KEY: ${{ secrets.NOTIFY_SANDBOX_API_KEY }}
          NOTIFY_TEMPLATE_LEASE_APPROVED: ${{ secrets.NOTIFY_TEMPLATE_LEASE_APPROVED }}
        run: yarn test:e2e

  # CDK Diff (only run on PR when infra files changed - NEVER on forks)
  cdk-diff:
    name: CDK Diff
    runs-on: ubuntu-latest
    needs: [infra-unit-tests]
    # Run on PRs when infra changed, but NEVER on forks (security requirement)
    # Fork protection is also enforced at the IAM level via repository_owner condition
    if: |
      github.event_name == 'pull_request' &&
      needs.infra-unit-tests.outputs.infra-changed == 'true' &&
      github.event.pull_request.head.repo.fork == false
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    defaults:
      run:
        working-directory: infra

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      # Defense-in-depth: Explicit fork check in case workflow conditions are bypassed
      - name: Security - Block Fork PRs
        if: github.event.pull_request.head.repo.fork == true
        run: |
          echo "::error::Fork PRs are not allowed to assume AWS roles for security reasons"
          exit 1

      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"
          cache-dependency-path: infra/yarn.lock

      - name: Install dependencies
        run: yarn install --immutable

      # Use readonly diff role (not deploy role) - allows any branch on origin repo
      # Fork protection is enforced at IAM level via repository_owner condition
      - name: Configure AWS credentials via OIDC (Readonly)
        uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7 # v6.0.0
        with:
          role-to-assume: arn:aws:iam::568672915267:role/GitHubActions-NDX-InfraDiff
          aws-region: ${{ env.AWS_REGION }}

      - name: CDK Diff
        id: diff
        run: |
          # Run diff and filter out expected warnings from readonly role
          # (cannot assume deploy/file-publishing roles - this is intentional)
          npx cdk diff --all 2>&1 | grep -v "current credentials could not be used to assume" | grep -v "but are for the right account. Proceeding anyway" | grep -v "fail: Bucket named 'cdk-hnb659fds-assets" | grep -v "Could not create a change set, will base the diff on template differences" | tee diff-output.txt || true
          # Escape for GitHub Actions output
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          head -c 60000 diff-output.txt >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR with diff
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          DIFF_OUTPUT: ${{ steps.diff.outputs.diff }}
        with:
          script: |
            const diff = process.env.DIFF_OUTPUT || 'No diff output available';
            const body = `## CDK Diff Results\n\n\`\`\`\n${diff}\n\`\`\``;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # CDK Deploy (only on push to main with infra changes)
  cdk-deploy:
    name: CDK Deploy
    runs-on: ubuntu-latest
    needs: [infra-unit-tests] # E2E tests temporarily disabled
    if: ${{ github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && needs.infra-unit-tests.outputs.infra-changed == 'true' }}
    permissions:
      id-token: write
      contents: read
    environment:
      name: infrastructure
    defaults:
      run:
        working-directory: infra

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"
          cache-dependency-path: infra/yarn.lock

      - name: Install dependencies
        run: yarn install --immutable

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7 # v6.0.0
        with:
          role-to-assume: arn:aws:iam::568672915267:role/GitHubActions-NDX-InfraDeploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Run pre-deploy validation
        run: |
          # Build TypeScript
          yarn build
          # Run tests
          yarn test --silent
          # Run lint
          yarn lint
          # Synthesize CDK
          npx cdk synth --quiet

      - name: CDK Deploy
        run: |
          npx cdk deploy --all \
            --require-approval never \
            --outputs-file cdk-outputs.json

      - name: Upload CDK outputs
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: cdk-outputs
          path: infra/cdk-outputs.json
          retention-days: 30

  # ==========================================================================
  # Signup Infrastructure (infra-signup/)
  # ==========================================================================

  # Signup infrastructure unit tests
  signup-infra-unit-tests:
    name: Signup Infrastructure Unit Tests
    runs-on: ubuntu-latest
    outputs:
      signup-infra-changed: ${{ steps.changes.outputs.signup-infra }}
    defaults:
      run:
        working-directory: infra-signup

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Check for signup infra changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: changes
        with:
          filters: |
            signup-infra:
              - 'infra-signup/**'
              - '.github/workflows/infra.yaml'

      - name: Skip notification
        if: steps.changes.outputs.signup-infra != 'true'
        run: |
          echo "::notice::No signup infrastructure files changed. Tests skipped but check passed."
          echo "Signup infra tests are only run when files in infra-signup/** are modified."

      - name: Enable Corepack
        if: steps.changes.outputs.signup-infra == 'true'
        run: corepack enable

      - name: Setup Node.js
        if: steps.changes.outputs.signup-infra == 'true'
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"
          cache-dependency-path: infra-signup/yarn.lock

      - name: Install dependencies
        if: steps.changes.outputs.signup-infra == 'true'
        run: yarn install --immutable

      - name: Run infrastructure unit tests
        if: steps.changes.outputs.signup-infra == 'true'
        run: yarn test

      - name: Run lint
        if: steps.changes.outputs.signup-infra == 'true'
        run: yarn lint

  # Signup Lambda CDK Deploy (to NDX account, deploys Lambda for /signup-api/*)
  signup-cdk-deploy:
    name: Signup CDK Deploy
    runs-on: ubuntu-latest
    needs: [signup-infra-unit-tests]
    if: ${{ github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && needs.signup-infra-unit-tests.outputs.signup-infra-changed == 'true' }}
    permissions:
      id-token: write
      contents: read
    environment:
      name: infrastructure
    defaults:
      run:
        working-directory: infra-signup

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"
          cache-dependency-path: infra-signup/yarn.lock

      - name: Install dependencies
        run: yarn install --immutable

      - name: Configure AWS credentials via OIDC (NDX Account)
        uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7 # v6.0.0
        with:
          role-to-assume: arn:aws:iam::568672915267:role/GitHubActions-NDX-InfraDeploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Run pre-deploy validation
        run: |
          # Build TypeScript
          yarn build
          # Run tests
          yarn test --silent
          # Run lint
          yarn lint
          # Synthesize CDK
          npx cdk synth --quiet

      - name: CDK Deploy
        run: |
          npx cdk deploy --all \
            --require-approval never \
            --outputs-file cdk-outputs.json

      - name: Upload CDK outputs
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: signup-cdk-outputs
          path: infra-signup/cdk-outputs.json
          retention-days: 30

  # ISB Cross-Account Role Deploy (to ISB account, enables Lambda to access Identity Store)
  # NOTE: Requires OIDC trust and role in ISB account (955063685555)
  # See infra-signup/isb-cross-account-role.yaml for the template being deployed
  isb-cross-account-role-deploy:
    name: ISB Cross-Account Role Deploy
    runs-on: ubuntu-latest
    needs: [signup-infra-unit-tests]
    if: ${{ github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && needs.signup-infra-unit-tests.outputs.signup-infra-changed == 'true' }}
    permissions:
      id-token: write
      contents: read
    environment:
      name: isb-infrastructure

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Configure AWS credentials via OIDC (ISB Account)
        uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7 # v6.0.0
        with:
          role-to-assume: arn:aws:iam::955063685555:role/GitHubActions-ISB-InfraDeploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Cross-Account Role
        run: |
          aws cloudformation deploy \
            --template-file infra-signup/isb-cross-account-role.yaml \
            --stack-name ndx-signup-cross-account-role \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides \
              GroupId=${{ secrets.ISB_NDX_USERS_GROUP_ID }} \
            --tags \
              project=ndx \
              feature=signup \
              managedby=cloudformation
